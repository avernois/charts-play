<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.4.1/chart.min.js" integrity="sha512-5vwN8yor2fFT9pgPS9p9R7AszYaNn0LkQElTXIsZFCL7ucT8zDCAqlQXDdaqgA1mZP47hdvztBMsIoFxq/FyyQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
    
    <script>
        var channel_id = 211219 ;
        var param = parseInt(window.location.hash.substring(1));
        var numberOfDays = isNaN(param) ? 7 : param;
        
        var dataSample = numberOfDays * 30 * 24;
        

    </script>


    <style>
        body {
            background-color: #3e3e40;
        }
    </style>
</head>

<body>
    <canvas id="myChart" style="background: #3e3e40"></canvas>
    
    <script>

    var chartColors = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(75, 192, 192)',
        blue: 'rgb(54, 162, 235)',
        purple: 'rgb(153, 102, 255)',
        grey: 'rgb(231,233,237)'
    };


    var update_data = function (channel, nbData, datasets) {
        var url = "https://api.thingspeak.com/channels/" + channel +"/feeds.json?results=" + nbData +"&average=60&round=1"
    
        fetch(url, { method: 'GET' })
        .then(function(response) {
            return response.json()
        })
        .then(function(json) {
            console.log("json", json)

            const feeds = json.feeds
            feeds.forEach(element => {
                    datasets.temp.push({x: moment(element.created_at), y: element.field3 })
                    datasets.humidity.push({x: moment(element.created_at), y: element.field1 })
            });

            const data = {
                datasets: [
                {
                        label: 'Humidity',
                        data: datasets.humidity,
                        borderColor: chartColors.blue,
                        pointBackgroundColor: chartColors.blue,
                        yAxisID: 'humidityAxis',
                    },
                    {
                        label: 'Temp',
                        data: datasets.temp,
                        borderColor: chartColors.red,
                        pointBackgroundColor: chartColors.red,
                        yAxisID: 'tempAxis',
                    },
                    
                ]
            };

            const config = {
                type: 'line',
                data: data,
                options: {
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    stacked: false,
                    scales: {    
                        x: {
                            type: 'time',
                            time: {
                                stepSize: 6,
                                tooltipFormat: 'HH:mm',
                                displayFormats: {
                                    day: 'MMMM Do, YY',
                                    hour: 'HH:mm'
                                }
                            },
                            grid: {
                                color: chartColors.grey,
                            },
                            ticks: {
                                major: {
                                    enabled: true, // <-- This is the key line
                                    fontStyle: 'bold', //You can also style these values differently
                                },
                                color: chartColors.grey
                            },                
                        },
                        humidityAxis: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            suggestedMin: 50,
                            suggestedMax: 100,
                            ticks: {
                                color: chartColors.blue
                            },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value > 72 && context.tick.value < 92 ) {
                                        return chartColors.green;
                                    }

                                    return chartColors.blue;
                                },
                            },
                        },
                        tempAxis: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            suggestedMin: -10,
                            suggestedMax: 40,
                            ticks: {
                                color: chartColors.red
                            },
                            grid: {
                                drawOnChartArea: false, // only want the grid lines for one axis to show up
                                color: 'white'
                            },
                        },
                    }
                },
            };
            Chart.defaults.font.size = 22;
            var ctx = document.getElementById('myChart');
            var myChart = new Chart(ctx, config);
        });
    }

    humidityTempData = { temp: [], humidity: [] }

    update_data(channel_id, dataSample, humidityTempData);


    console.log("humidityTempData", humidityTempData);
    
    // data: [{x:'2016-12-25', y:20}, {x:'2016-12-26', y:10}]

    
    </script>
    </body>
