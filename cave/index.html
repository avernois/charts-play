<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.4.1/chart.min.js" integrity="sha512-5vwN8yor2fFT9pgPS9p9R7AszYaNn0LkQElTXIsZFCL7ucT8zDCAqlQXDdaqgA1mZP47hdvztBMsIoFxq/FyyQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
    
    <script>
        var channel_id = 211219 ;
        var param = parseInt(window.location.hash.substring(1));
        var numberOfDays = isNaN(param) ? 7 : param;
        
        var dataSample = numberOfDays * 30 * 24;
        

    </script>

</head>

<body>
    <div class="chart-container" style="position: relative; height:40vh; width:80vw">
        <canvas id="myChart"></canvas>
    </div>
    
    
    <script>

    var update_data = function (channel, nbData, datasets) {
        var url = "https://api.thingspeak.com/channels/" + channel +"/feeds.json?results=" + nbData
    
        fetch(url, { method: 'GET' })
        .then(function(response) {
            return response.json()
        })
        .then(function(json) {
            console.log("json", json)

            const feeds = json.feeds
            feeds.forEach(element => {
                if(element.entry_id % 15 == 0) {
                    datasets.temp.push({x: moment(element.created_at), y: element.field3 })
                    datasets.humidity.push({x: moment(element.created_at), y: element.field1 })
                }
            });

            var ctx = document.getElementById('myChart');

            const data = {
                datasets: [
                    {
                        label: 'Temp',
                        data: datasets.temp,
                        borderColor: 'rgba(255, 0, 0, 1)',
                        backgroundColor: 'rgba(255, 0, 0, 0.1)',
                        yAxisID: 'tempAxis',
                    },
                    {
                        label: 'Humidity',
                        data: datasets.humidity,
                        borderColor: 'rgba(0, 0, 255, 1)',
                        yAxisID: 'humidityAxis',
                    }
                ]
            };

            const config = {
                type: 'line',
                data: data,
                options: {
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    stacked: false,
                    scales: {
                        x: {
                            type: 'time',
                            display: true,
                            distribution: 'linear',
                            ticks: {
                                autoskip: true,
                                source: 'data',
                                major: {
                                    enabled: true
                                },
                            }
                        },
                        tempAxis: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            suggestedMin: -10,
                            suggestedMax: 40,
                            ticks: {
                                color: '#FF0000'
                            },
                        },
                        humidityAxis: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                color: '#0000FF'
                            },
                            // grid line settings
                            grid: {
                                drawOnChartArea: false, // only want the grid lines for one axis to show up
                            },
                            color: '#00FF00'
                        },
                    }
                },
            };



            var myChart = new Chart(ctx, config);
        });
    }

    humidityTempData = { temp: [], humidity: [] }

    update_data(channel_id, dataSample, humidityTempData);


    console.log("humidityTempData", humidityTempData);
    
    // data: [{x:'2016-12-25', y:20}, {x:'2016-12-26', y:10}]

    
    </script>
    </body>
